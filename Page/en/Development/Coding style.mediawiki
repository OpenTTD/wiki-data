[[Translation:en/Development/Coding style]]
[[Category:en/Development]]
== Coding style ==

To achieve a coherent whole, here are some guidelines for the coding style used in OTTD.

* FunctionsLookLikeThis()
* Variable names/structure members are all lowercase, and may also contain _
* Variables are declared at the beginning of a block { }, as specified in ANSI-C89
** Never declare variables halfway a function or other block. This is especially for coders using gcc, since gcc won't complain, but MSVC does. Up till now, I have not found an option in MSVC to allow it, nor an option in gcc to forbid/warn for it. Starting from gcc >= 3.4, it does give a warning (automatically enabled by the Makefile).
* Local variable names should be short
* StructsLookLikeThis and get typedefed:
<pre>
 typedef struct foo {
   // stuff
 } foo;
</pre>
* Global variables start with a _
* Use 'const' and 'static' when possible
* ENUMS_LOOK_LIKE_THIS 
* Use simple enums for holding weakely related constants like this:
<pre>
enum {
  NUMBER_OF_BIRDCAGES    = 10,
  MAX_BIRDS_PER_BIRDCAGE = 3,
}
</pre>
** Notice the , at the end of the last entry. We add it, so that we can easily add more values if needed.
** Align the initialisers with spaces.
* Stricter enums should be used for more closely related sequences and should be typedeffed if they are used as the contents of an array, return value, parameter type or variable type:
<pre>
  typedef enum Birds {
    BIRD_HAWK    = 0,
    BIRD_DUCK    = 1,
    BIRD_GOOSE   = 2,
    BIRD_END,
    INVALID_BIRD = 0xFF
  } Bird;
</pre>
Some things to notice. 
**We say "enum Birds" and typedef it as "Bird". Rationale: We list a number of "Birds", but when I have a variable of this type, the type is "Bird" (I'll put just one bird in the variable). <font style="color:red">Do not forget the name of the enum ("Birds"). Even though gcc will happily compile and run (as it should), MSVC won't properly initialize arrays that have this enum as their type. No error, no warning, just broken (but running) code.</font>
**Furthermore, inital values are optional, avoid them if possible. If you do need them for backward compatibility mostly, indent them nicely.
**We add a BIRD_END without initialiser, so that it will automatically store the largest bird + 1. We can declare an array like this:
<pre>
const uint WingSpan[BIRD_END] = {
  20, /* BIRD_HAWK */
  15, /* BIRD_DUCK */
  30  /* BIRD_GOOSE */
};
</pre>
**Only add an INVALID_BIRD if appriopriate
* Use enums instead of #define
* Tab size is 2 spaces. Never use spaces as indentation.
* Style for if:
<pre>
 if (a == b) {
   foo();
 } else {
   bar();
 }
</pre>
: Alternatively:
<pre>
 if (a == b)
   foo();
</pre>

* don't treat non-flags as flags: if (char_pointer != NULL && *char_pointer != '\0') instead of if (char_pointer && *char_pointer)

* put a space before and after binary operators: a + b, a == b, a & b, a <<= b, etc.. Exceptions are ".", "->" and "[]" (no spaces) and "," (just space after it)

* space after "for", "if", "switch" and "while"

* { for a function starts at the second line.
<pre>
      FunctionsLookLikeThis(int i_am_a_variable)
      {
        code...
      }
</pre>
* Avoid trailing whitespace. That is, tabs or space on the end of line should never occur. The svn server will not allow patches with traling whitespace applied. To find out if/where you have trailing whitespace, you could use the following (unix/bash) command:
<pre>grep -n -R --include "*.[ch]" '[ 	]$' * | grep --invert-match ".diff" | grep --invert-match ".patch"</pre>
Automatically removing whitespace is also possible, who can put up a command for that here?

== Code documentation ==

=== Overview ===
We use [http://doxygen.org/ Doxygen] to automatically generate documentation from comments inside the source code. It scans the source files for comments with certain patterns and uses the information contained within those to generate documentation that will help understanding how things work. With that we have to follow some rules about how comments are being written, and that's what this section is for.


First off, Doxygen knows two different kinds of comments:
*''Brief descriptions'': one-liners that describe the function roughly ([http://docs.openttd.org/annotated.html example])
*''Detailed descriptions'': as the name suggests, these contain the detailed function/purpose of the entity they describe ([http://docs.openttd.org/structBridge__t.html example])
You can omit either one or put them into different places but there's only one brief and one detailed description allowed for the same entity.


Furthermore, Doxygen knows three modes for documenting an entity:
*Before the entity
*After the entity
*In a different file
The latter is a little harder to maintain since the prototype of the entity it describes then is stored in several places (e.g. the .h file and the file with the descriptions). Also while it makes the code easier to read it also makes it easier to omit the important step of updating the description of an entity if it was changed - and we all know why that shouldn't happen ;)<br>
Because of those reasons, we will only use the first two documentation schemes.


On top of that Doxygen also caters to the needs of those who are used to the Qt and JavaDoc comment styles because it supports both:
*Qt style example: '''int i; //!< The counter for the main loop'''
*JavaDoc style example: '''int i; /**< The counter for the main loop */'''
It also supports more comment styles but those two are the ones which are standardized. For OTTD we'll be using the JavaDoc style. One of the reasons is that it has a feature that the Qt style doesn't offer: JavaDoc style comment blocks will automatically start a brief description which ends at the first dot followed by a space or new line. Everything after that will also be part of the detailed description. The guideline in the next section will explain what this means for you.

=== General JavaDoc style comments ===

The general structure of a JavaDoc style comment is
 /**
  * This is the brief description. And this sentence contains some further explanations that will appear in the detailed description only.
  */
and the resulting descriptions of that block would be:
*''Brief description'': This is the brief description.
*''Detailed description'': This is the brief description. And this sentence contains some further explanations that will appear in the detailed description only.
The distinction between the brief and detailed descriptions is made by the dot followed by a space/newline, so if you want to use that inside the brief description you need to escape the space/newline: 
 /**
  * This is a brief description (e.g.\ using only a few words). Details go here.
  */


If you're doing a one-line comment it could look like that:
 int i; /**< This is the description. */
However since that might be a little hard to read we can also use
 int i; ///< This is the description.
instead.


Also in the comment block you can include so-called structural commands which tell Doxygen what follows. In general, their area of effect begins after the command word and ends when a blank line or some other command is encountered. Also, multiple occurences of the same structural command within a comment block or the referring entity will be joined in the documentation output usually.<br>
The full list of supported structural commands can be found [http://www.stack.nl/~dimitri/doxygen/commands.html here] while this table shows the ones you should know about:


{|
|'''This structural command...'''||'''...does the following'''||'''Usage example(s)'''
|-
| ||<small>'''Additional information about an entity'''</small>||
|-
|'''@attention'''||Starts a paragraph where a message that needs attention may be entered. The paragraph will be indented.||'''@attention Whales crossing!'''
|-
|'''@author'''||Starts a paragraph where one or more author names may be entered. The paragraph will be indented. Multiple adjacent @author commands will be joined into a single paragraph and separated by commas. Alternatively, one @author command may mention several authors.||'''@author Bjarni'''
|-
|'''@brief'''||Starts a paragraph that serves as a brief description. For classes and files the brief description will be used in lists and at the start of the documentation page. For class and file members, the brief description will be placed at the declaration of the member and prepended to the detailed description. A brief description may span several lines (although it is advised to keep it brief!).||'''@brief This is the brief description.'''
|-
|'''@bug'''||Starts a paragraph where one or more bugs may be reported. The paragraph will be indented. Multiple adjacent @bug commands will be joined into a single paragraph. Each bug description will start on a new line. Alternatively, one @bug command may mention several bugs.||'''@bug Memory leak in here?'''
|-
|'''@note'''||Starts a paragraph where a note can be entered. The paragraph will be indented.||'''@note Might be slow'''
|-
|'''@todo'''||Starts a paragraph where a TODO item is described. The description will also add an item to a separate TODO list. The two instances of the description will be cross-referenced. Each item in the TODO list will be preceded by a header that indicates the origin of the item.||'''@todo Better error checking'''
|-
|'''@warning'''||Starts a paragraph where one or more warning messages may be entered. The paragraph will be indented.||'''@warning Not thread safe!'''
|-
| ||<small>'''Function related commands'''</small>||
|-
|'''@return'''||Starts a return value description for a function.||'''@return a character pointer'''
|-
|'''@param'''||Starts a parameter description for a function parameter with name <parameter-name>. Followed by a description of the parameter. The existence of the parameter is checked and a warning is given if the documentation of this (or any other) parameter is missing or not present in the function declaration or definition.<br><br>The @param command has an optional attribute specifying the direction of the attribute. Possible values are "in" and "out".||'''@param[out] dest The memory area to copy to.<br>@param[in]  src  The memory area to copy from.<br>@param  n    The number of bytes to copy'''
|-
|'''@see'''||Starts a paragraph where one or more cross-references to classes, functions, methods, variables, files or URL may be specified. Two names joined by either :: or # are understood as referring to a class and one of its members. One of several overloaded methods or constructors may be selected by including a parenthesized list of argument types after the method name. [http://www.stack.nl/~dimitri/doxygen/autolink.html Here] you can find detailed information about this feature.||'''@see OtherFunc()'''
|-
| ||<small>'''Commands for character formatting'''</small>||
|-
|'''@b'''||Displays the following word using a bold font. Equivalent to &lt;b&gt;word&lt;/b&gt;. To put multiple words in bold use &lt;b&gt;multiple words&lt;/b&gt;.||'''...@b this and @b that...'''
|-
|'''@c / @p'''||Displays the parameter <word> using a typewriter font. You can use this command to refer to member function parameters in the running text. To have multiple words in typewriter font use &lt;tt&gt;multiple words&lt;/tt&gt;.||'''... the @p x and @p y coordinates are used to...'''
|-
|'''@arg / @li'''||This command has one argument that continues until the first blank line or until another @arg / @li is encountered. The command can be used to generate a simple, not nested list of arguments. Each argument should start with an @arg / @li command.||'''@arg @c AlignLeft left alignment.<br>@arg @c AlignCenter center alignment.<br>@arg @c AlignRight right alignment'''
|-
|'''@n'''||Forces a new line. Equivalent to and inspired by the printf function.||'''You kidding? :p'''
|}

=== The art of proper commenting ===
==== Files ====

The first step towards getting everything documented properly is to give the files themselves a description. We achieve that by putting a @file command inside a JavaDoc style comment which has been placed at the beginning of the file:
 /** @file
  * This is the brief description.
  * And then follow further explanations here that will appear in the detailed description only.
  */
<warning>Note: if a file lacks this comment block then NO entities in that file will be documented!</warning>

==== Functions ====

Functions are commented/documented in the .c file while inlines get commented on in the .h files they reside in. While small inlines might be able to get away with a 3 or 4 line comment, bigger inlines and functions should follow this scheme:
 /**
  * A brief explanation of what the function does and/or what purpose it serves.
  * Then follows a more detailed explanation of the function that can span multiple lines.
  *
  * @param foo Explanation of the foo parameter
  * @param bar Explanation of the bar parameter
  * @return The sum of foo and bar (@return can be omitted if the return type is void)
  *
  * @see SomeOtherFunc()
  * @see SOME_ENUM
  * 
  * @author Bjarni, Darkvater
  * @bug Some bug description
  * @bug Another bug description which continues in the next line
  *           and ends with the following blank line
  *
  * @todo Some to-do entry
  */
 static int FooBar(int foo, int bar)
 {
   return foo + bar;
 }

The @see, @author, @bug, @todo, @warning, etc. fields are optional but obviously nice to have, come in handy and are quick to update, too.
''Note'': when passing function names to @see you don't have to specify the parameter list - it simply stays empty.
Also, don't assume that the parameter and return values are so obvious that there's no need to document them! Any coder who has to work on the code will for sure appreciate every hint he/she can get from the person who worked on it before.
You can add @bug and @todo fields to the main description comment of the function or add them where the stuff actually is that those fields would refer to. To see how that should be done, look at [[#random-code-notices|Random code notices]] below. It doesn't really matter where they appear, since Doxygen automatically builds a [http://docs.openttd.org/todo.html global to-do list] with all entities listed that have a to-do field, for example.

==== Enums / defines / global variables ====

You should also comment your enums, defines and global variables. There are four possible styles:
# '''/** Use this comment style if you wish to place the comment above the entity (JavaDoc style) */<br>int i;'''<br>
# '''int i; /**< Use this comment style if you wish to place the comment on the same line as the entity (JavaDoc style) */'''<br>
# '''/// Use this comment style if you wish to place the comment above the entity<br>int i;'''<br>
# '''int i; ///< Use this comment style if you wish to place the comment on the same line as the entity'''

While 1 and 2 should be prefered in order to stay in sync with the commenting standard it also should be easy to see that 3 and 4 are quicker to type and have a better readablity. With that it's up to you which one you use.

Also note that styles 2 and 4 have the same structure and meaning as the regular comment blocks numbered 1 and 3 - only the < indicates that the entity it refers to is located in front of the block instead of after the block.

==== Structs ====

A typical struct comment should look like this:
 /**
  * A short description of the struct.
  * More detailed description of the its usage.
  *
  * @see [link to anything of interest]
  */
 typedef struct foo {
  int16 x;  ///< x does this
  int16 y;  ///< y does that
 }

As before, @see & Co are optional but should be added if it could be helpful.

==== Random code notices ====

Areas of interest or suggestions for improving the code should be marked as follows:
 int i = 6; ///< What is this magic number and what does it do?
or, for comments that require more than a simple one-liner (JavaDoc):
 /** don't bother calling the callback when we have regular tracks only.
  * it's usually not needed anyway. that will speed up things.
  */
 direction = _new_dir[FIND_FIRST_BIT(bits)][direction];
 assert(direction != 0xFF);
 if (tile == tile_org) goto popnext; // detect infinite loop..
or for the lazy:
 /// don't bother calling the callback when we have regular tracks only.
 /// it's usually not needed anyway. that will speed up things.
 direction = _new_dir[FIND_FIRST_BIT(bits)][direction];
 assert(direction != 0xFF);
 if (tile == tile_org) goto popnext; // detect infinite loop..
But please: in order to maintain proper style, use the JavaDoc style when comments span more than 2~3 lines.

Note: By default, Doxygen doesn't mark such comments in a special way, it merely copies the comment as-is into the description of the entity it belongs to. If that isn't what you want you might want to use
 /// @note don't bother calling the callback when we have regular tracks only.
 /// @note it's usually not needed anyway. that will speed up things.
 direction = _new_dir[FIND_FIRST_BIT(bits)][direction];
 assert(direction != 0xFF);
 if (tile == tile_org) goto popnext; // detect infinite loop..
instead. That way you can also integrate @todo, @bug, @warning, etc. fields and Doxygen will put them into the [http://docs.openttd.org/bug.html global bug list], for example.