[[Translation:en/Archive/Source/OpenTTDDevBlackBook/Settings/AddSetting]]
{{en/Development/Navigation}}

This is a guide on creating patch settings that the user can manipulate and saving them into the config file. This article does '''not''' cover creating a new window.

==About save games==
The savegame holds the map and the data needed to continue a game. Which variables are saved are controlled by data CHUNKs, usually defined in files under the saveload folder.

The game settings are saved in chunks defined in settings.h. Search for the variable <code>const SettingDesc _settings[]</code>.

==About Patch Settings==
The patch settings are grouped into areas - but this is just for clarity of reading. Generally minor single line settings get squeezed into their appropriate position in the list. Larger groups of settings are added at the end of the list (somewhere after YAPF options).

Patch settings can be saved in up to three different locations (currently); a single player game, a network game, and the config.cfg file. This is controlled by one of the values given for each of the patch settings.

====Current Patch Categories====
The patch categories can be seen from the advanced settings window, so they're easily recognizable.

*[[en/Archive/Manual/Settings/Advanced Settings/Interface|Interface]] - General interface options such as toolbar options and main window options.
*[[en/Archive/Manual/Settings/Advanced Settings/Construction|Construction]] - Options dealing with what and how you can construct things.
*[[en/Archive/Manual/Settings/Advanced Settings/Vehicles|Vehicles]] - Options dealing with vehicle behavior.
*[[en/Archive/Manual/Settings/Advanced Settings/Stations|Stations]] - Options dealing with station behavior.
*[[en/Archive/Manual/Settings/Advanced Settings/Economy|Economy]] - Options dealing with the economy.
*[[en/Archive/Manual/Settings/Advanced Settings/Competitors|Competitors]] - Options dealing with AI competitors.

NOTE: This document does not cover how to create a new category.

==Adding a Patch Setting==
There are several files that you need to edit in order to add a patch setting.  This section lists those files and tells you what you need to do to each.  For the most part, you have to look at the surrounding code to figure out where the most appropriate place for your new patch variable to go, but unless you have a radically new idea, there will probably be a place for you.

====english.txt (and language files)====
First and foremost, you must add text entries into [http://svn.openttd.org/trunk/src/lang/english.txt english.txt] (all other language files are managed by the translators).  If you speak another language, you may also add your entries into that file in your patch.  For any other languages, just leave them and somebody will eventually translate it for you.

Take a look at the link above to get a feel for the text file.  Any patch option strings should begin with the STR_CONFIG_SETTING_ extension.  

<pre>
STR_CONFIG_SETTING_MY_VAR_OPT         :{LTBLUE}My variable option: {ORANGE}{STRING2} 
STR_CONFIG_SETTING_MY_BOOL_OPT        :{LTBLUE}My boolean option {ORANGE}{STRING2}
</pre>

Note that there are no tabs in this file, only spaces.

====settings_type.h====
There are several structures that keep track of the current configuration. They are named after each setting category. They are located in [http://svn.openttd.org/trunk/src/settings_type.h settings_type.h].

Find an appropriate structure for your patch setting and add a line similar to that shown here:

<pre>
	uint8 my_var_opt;	///< *Describe what my_var_opt is about*
	bool my_bool_opt;	///< *Describe what my_bool_opt is about*
</pre>

====settings_gui.cpp====
You must also define a string that contains your variable name for the purposes of saving and loading from the [[en/Archive/Manual/Settings/Openttd.cfg]] file.  These are defined in [http://svn.openttd.org/trunk/src/settings_gui.cpp settings_gui.cpp].

There is one array of strings defined for each category (described above) for organization purposes:

*_settings_ui[]
*_settings_construction[]
*_settings_stations[]		
*_settings_economy[]
*_settings_ai[]
*_settings_vehicles[]

You must define your string in the most appropriate one:

<pre>
	SettingEntry("my_var_opt"),
	SettingEntry("my_bool_opt"),
</pre>

====settings.ini====
The last change you have to make determines the behaviour of the Configure Patches window and exactly how your setting will be saved to [[en/Archive/Manual/Settings/Openttd.cfg]].  This is set with an entry in [http://svn.openttd.org/trunk/src/table/settings.ini settings.ini].

While you only add a single entry per setting that you make, it is fairly complicated. To give you an idea here is an example:

 [SDT_VAR]
 base     = GameSettings
 var      = my_var_opt
 type     = SLE_UINT8
 from     = 161
 to       = SL_MAX_VERSION
 flags    = 0
 guiflags = 0
 def      = 100
 min      = 10
 max      = 100
 interval = 5
 str      = STR_CONFIG_SETTING_MY_VAR_OPT
 proc     = NULL

 [SDT_BOOL]
 base     = GameSettings
 var      = my_bool_opt
 from     = 161
 to       = SL_MAX_VERSION
 flags    = 0
 guiflags = 0
 def      = true
 str      = STR_CONFIG_SETTING_MY_BOOL_OPT
 proc     = NULL

Of course you will have to place it in the appropriate order in the settings.ini file (hopefully this will be fairly obvious).

Following is a detailed explanation of what it all means:

=====Patch Setting Types=====
The format of the patch setting can be a bit hard to follow, but is quite straightforward.  These are the two standard types of settings, i.e. SDT_BOOL and SDT_VAR

*base: GameSettings
*var: The variable name
*type: data size for the variable - not required for BOOL, but can be a variety of sizes; SLE_UINT8, SLE_INT16, SLE_UINT32, etc.   etc... pick what you need
*flags: this is the most awkward to understand, and is quite cryptic. It can take the following values:
**0 (zero) = Default behaviour: Save in save game and openttd.cfg.  Sync with Network (Only the server can set the option)
**N = Do '''not''' sync with network. (Each player can set their own)
**S = Do '''not''' save in save game (but save in openttd.cfg).  '''Also''' does '''not''' sync with network.  (Each player can set their own)
**C = Do not save in openttd.cfg, but save in save game.
*guiflags: Affects how the option is displayed
**D0 = Disable option.  Grey out for now but leave in for future use?  Maybe for internal use only.
**NC = No Commas.  Display numbers without any thousands separators.
**MS = Multi-string.  Option displays various strings instead of numbers for settings.
**NO = Network Only.  Setting only applies to network games
**CR = Currency.  Number in string will be converted to proper currency.
*def: default value (true or false for BOOL, any valid value for VAR)
*min, max, interval: min value, max value and interval by which integer value increments/decrements when using the yellow arrows (only applicable to VAR, obviously) 
*str: the string used in the language file for the patch setting when displayed in the Patch Settings control panel. If you don't need to display it, just leave it as NULL.
*proc: the procedure to call when the value is changed. Just leave this as NULL - safer that way.
*from, to: Range of OpenTTD versions for which the setting is valid (see below)

=====SAVEGAME_VERSION=====

You have your saved patch variable, but if you add it straight, OTTD will expect to find it in every savegame. So there is an extra pair of entries available for conditional variables; ones only available for a range of savegame versions. The savegame version number is found near the start of [http://svn.openttd.org/trunk/src/saveload/saveload.cpp saveload.cpp].

When OTTD loads a data chunk, it compares the savegame version it was compiled with, with the savegame version in the savegame. By checking the <from> and <to> version numbers in the patch settings, it can see whether it supports the feature, and how to handle it.

This way, you can control whether your feature is saved, and if it is, whether that save is compatible with previous versions.

'''Note:''' by just defining your saved variable in the patch settings, you automatically make saves with your OTTD incompatible with everybody else's. Also, unless you follow the procedure below, you will not be able to *load* normal OTTD games with your version either!

This is where the savegame version, and conditional vars save your bacon.

If the current trunk is at version 160, but you have a new feature that needs its settings vars saving, then ALWAYS increase the savegame version. This is known as a Savegame BUMP.

When a normal OTTD tries to load a savegame from your system, it will see the savegame bump, and gracefully say "sorry, i cant load that - its too new for me".

However, to do the reverse - you loading older OTTD games - you need to identify your patch settings as "new in version XX" by using the <from> and <to> entries.

So for our example (see above): we BUMP the savegame to 161, and set our vars with a <from> of 161, and a <to> of SL_MAX_VERSION, which as you can guess means "from now on". 



[[Category:en/Archive/Source/OpenTTDDevBlackBook|P]]
[[Category:en/Development]]